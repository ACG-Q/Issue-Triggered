name: Convert APKS to APK

on:
  issues:
    types: [opened, edited, labeled] # ç›‘å¬ Issue çš„åˆ›å»ºã€ç¼–è¾‘å’Œæ·»åŠ æ ‡ç­¾äº‹ä»¶

jobs:
  convert-apks-to-apk:
    if: contains(github.event.issue.labels.*.name, 'apks-to-apk-converter') # åªåœ¨æœ‰ç‰¹å®šæ ‡ç­¾æ—¶è¿è¡Œ
    runs-on: ubuntu-latest

    steps:
    # Step 1: æ£€å‡ºä»£ç 
    - name: Checkout code
      uses: actions/checkout@v3

    # Step 2: æå– Issue Body ä¸­çš„æ–‡ä»¶é“¾æ¥
    - name: Extract APKS file URL
      id: extract-url
      run: |
        echo "${{ github.event.issue.body }}" > issue_body.txt
        url=$(grep -oP '(https://[^\s]+\.apks)' issue_body.txt || echo "none")
        echo "url=$url" >> $GITHUB_ENV

    # Step 3: ä¸‹è½½ APKS æ–‡ä»¶
    - name: Download APKS
      if: env.url != 'none'
      run: |
        curl -L "${{ env.url }}" -o input.apks
      shell: bash

    # Step 4: è®¾ç½® Java ç¯å¢ƒ
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '21'

    # Step 5: è‡ªåŠ¨ä¸‹è½½æœ€æ–°çš„ BundleTool
    - name: Download the latest BundleTool
      run: |
        LATEST_VERSION=$(curl -s https://api.github.com/repos/google/bundletool/releases/latest | grep "tag_name" | cut -d '"' -f 4)
        DOWNLOAD_URL="https://github.com/google/bundletool/releases/download/${LATEST_VERSION}/bundletool-all-${LATEST_VERSION#v}.jar"
        curl -L $DOWNLOAD_URL -o bundletool.jar
        if [ ! -f "bundletool.jar" ]; then
          echo "Failed to download BundleTool." && exit 1
        fi

    # Step 6: è½¬æ¢ APKS æ–‡ä»¶ä¸º APK
    - name: Convert APKS to APK
      run: |
        java -jar bundletool.jar build-apks \
          --apks=input.apks \
          --output=output.apk \
          --mode=universal
    
    # Step 7: ä¸Šä¼ ç”Ÿæˆçš„ APK æ–‡ä»¶åˆ° Artifacts
    - name: Upload APK to Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: apk-${{ github.event.issue.number }}
        path: output.apk

    # Step 8: å›å¤ Issueï¼Œæä¾› Artifact çš„ä¸‹è½½é“¾æ¥
    - name: Comment on Issue
      uses: actions/github-script@v6
      with:
        script: |
          const artifactUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`
          github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: `ğŸ‰ Conversion complete!  
          Here is your APK file:  
          [Download APK from Artifacts](${artifactUrl})`
          })
